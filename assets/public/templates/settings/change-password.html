<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meryl - Change Password</title>
    {% include "components/dependencies.html" %}
    <style>
        .password-card {
            max-width: 500px;
            margin: 2rem auto;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .password-requirements {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 0.5rem;
        }

        .requirement {
            margin-bottom: 0.25rem;
        }

        .requirement.valid {
            color: #28a745;
        }

        .btn-main {
            background-color: var(--main-color);
            border-color: var(--main-color);
            color: white;
        }

        .btn-main:hover {
            background-color: var(--main-color-dark);
            border-color: var(--main-color-dark);
        }

        .btn-secondary {
            background-color: var(--main-color-subtle);
            border-color: var(--main-color-subtle);
            color: white;
        }

        .btn-secondary:hover {
            background-color: var(--main-color-dark);
            border-color: var(--main-color-dark);
        }
    </style>
</head>

<body class="bg-body-tertiary min-vh-100">
    {% include "components/navbar.html" with context %}

    <div class="container-fluid row">

        {% include "components/settings-sidebar.html" with context %}

        <div class="col">
            <div class="container-fluid">
                <div class="row justify-content-center">
                    <div class="col-12 col-md-8 col-lg-6">
                        <div class="card password-card">
                            <div class="card-body">
                                <div class="text-center mb-4">
                                    <i class="fa-solid fa-key fa-3x text-main-color mb-3"></i>
                                    <h2 class="card-title">Change Password</h2>
                                    <p class="text-muted">Choose a strong password to keep your account secure</p>
                                </div>

                                <form id="password-form">
                                    <div class="form-group">
                                        <label for="current-password" class="form-label">Current Password</label>
                                        <input type="password" class="form-control" id="current-password"
                                            name="current_password" required>
                                    </div>

                                    <div class="form-group">
                                        <label for="new-password" class="form-label">New Password</label>
                                        <input type="password" class="form-control" id="new-password"
                                            name="new_password" required>
                                        <div class="password-requirements" id="password-requirements">
                                            <div class="requirement" id="req-length">
                                                <i class="fa-solid fa-circle" id="icon-length"></i>
                                                At least 8 characters
                                            </div>
                                            <div class="requirement" id="req-uppercase">
                                                <i class="fa-solid fa-circle" id="icon-uppercase"></i>
                                                At least one uppercase letter
                                            </div>
                                            <div class="requirement" id="req-lowercase">
                                                <i class="fa-solid fa-circle" id="icon-lowercase"></i>
                                                At least one lowercase letter
                                            </div>
                                            <div class="requirement" id="req-number">
                                                <i class="fa-solid fa-circle" id="icon-number"></i>
                                                At least one number
                                            </div>
                                            <div class="requirement" id="req-special">
                                                <i class="fa-solid fa-circle" id="icon-special"></i>
                                                At least one special character
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="confirm-password" class="form-label">Confirm New Password</label>
                                        <input type="password" class="form-control" id="confirm-password"
                                            name="confirm_password" required>
                                        <div class="form-text" id="password-match-text"></div>
                                    </div>

                                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                        <a href="/settings/profile" class="btn btn-secondary me-md-2">
                                            <i class="fa-solid fa-arrow-left"></i> Back to Profile
                                        </a>
                                        <button type="submit" class="btn btn-main" id="change-password-btn" disabled>
                                            <i class="fa-solid fa-key"></i> Change Password
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Toast Container -->
            <div class="toast-container position-fixed top-0 end-0 p-3">
                <div id="password-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                        <i class="fa-solid fa-circle-check text-success me-2"></i>
                        <strong class="me-auto">Success</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div class="toast-body" id="toast-message">
                        Password changed successfully!
                    </div>
                </div>
            </div>

            <script>
                const passwordInput = document.getElementById('new-password');
                const confirmPasswordInput = document.getElementById('confirm-password');
                const changePasswordBtn = document.getElementById('change-password-btn');
                const passwordMatchText = document.getElementById('password-match-text');

                // Password validation requirements
                const requirements = {
                    length: { element: document.getElementById('req-length'), icon: document.getElementById('icon-length') },
                    uppercase: { element: document.getElementById('req-uppercase'), icon: document.getElementById('icon-uppercase') },
                    lowercase: { element: document.getElementById('req-lowercase'), icon: document.getElementById('icon-lowercase') },
                    number: { element: document.getElementById('req-number'), icon: document.getElementById('icon-number') },
                    special: { element: document.getElementById('req-special'), icon: document.getElementById('icon-special') }
                };

                function validatePassword(password) {
                    const checks = {
                        length: password.length >= 8,
                        uppercase: /[A-Z]/.test(password),
                        lowercase: /[a-z]/.test(password),
                        number: /\d/.test(password),
                        special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
                    };

                    let allValid = true;

                    for (const [key, check] of Object.entries(checks)) {
                        if (check) {
                            requirements[key].element.classList.add('valid');
                            requirements[key].icon.className = 'fa-solid fa-check-circle';
                        } else {
                            requirements[key].element.classList.remove('valid');
                            requirements[key].icon.className = 'fa-solid fa-circle';
                            allValid = false;
                        }
                    }

                    return allValid;
                }

                function checkPasswordsMatch() {
                    const password = passwordInput.value;
                    const confirmPassword = confirmPasswordInput.value;

                    if (confirmPassword === '') {
                        passwordMatchText.textContent = '';
                        passwordMatchText.className = 'form-text';
                        return false;
                    }

                    if (password === confirmPassword) {
                        passwordMatchText.textContent = 'Passwords match!';
                        passwordMatchText.className = 'form-text text-success';
                        return true;
                    } else {
                        passwordMatchText.textContent = 'Passwords do not match!';
                        passwordMatchText.className = 'form-text text-danger';
                        return false;
                    }
                }

                passwordInput.addEventListener('input', function () {
                    const isValid = validatePassword(passwordInput.value);
                    const passwordsMatch = checkPasswordsMatch();

                    changePasswordBtn.disabled = !(isValid && passwordsMatch);
                });

                confirmPasswordInput.addEventListener('input', function () {
                    const isValid = validatePassword(passwordInput.value);
                    const passwordsMatch = checkPasswordsMatch();

                    changePasswordBtn.disabled = !(isValid && passwordsMatch);
                });

                // Form Submission
                document.getElementById('password-form').addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const currentPassword = document.getElementById('current-password').value;
                    const newPassword = document.getElementById('new-password').value;
                    const confirmPassword = document.getElementById('confirm-password').value;

                    if (newPassword !== confirmPassword) {
                        showToast('New passwords do not match', 'danger');
                        return;
                    }

                    try {
                        const response = await fetch('/api/users/change-password', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                current_password: currentPassword,
                                new_password: newPassword
                            })
                        });

                        if (response.ok) {
                            showToast('Password changed successfully!', 'success');
                            // Clear form
                            document.getElementById('password-form').reset();
                            // Reset validation states
                            for (const req of Object.values(requirements)) {
                                req.element.classList.remove('valid');
                                req.icon.className = 'fa-solid fa-circle';
                            }
                            passwordMatchText.textContent = '';
                            passwordMatchText.className = 'form-text';
                            changePasswordBtn.disabled = true;
                        } else {
                            const error = await response.json();
                            showToast('Error: ' + error.message, 'danger');
                        }
                    } catch (error) {
                        showToast('Network error occurred', 'danger');
                    }
                });

                function showToast(message, type = 'success') {
                    const toastEl = document.getElementById('password-toast');
                    const toastBody = document.getElementById('toast-message');
                    const toastHeader = toastEl.querySelector('.toast-header strong');

                    toastBody.textContent = message;
                    toastHeader.textContent = type === 'success' ? 'Success' : 'Error';

                    if (type === 'danger') {
                        toastHeader.className = 'me-auto text-danger';
                        toastEl.querySelector('.toast-header i').className = 'fa-solid fa-circle-exclamation text-danger me-2';
                    } else {
                        toastHeader.className = 'me-auto';
                        toastEl.querySelector('.toast-header i').className = 'fa-solid fa-circle-check text-success me-2';
                    }

                    const toast = new bootstrap.Toast(toastEl);
                    toast.show();
                }
            </script>
</body>

</html>